{% extends "base.html" %}
{% block title %}{{ doc.title }}{% endblock %}

{% block content %}
<script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
<script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm sticky-top" style="top: 20px; z-index: 1;">
            <div class="card-body">
                <h5 class="card-title">{{ doc.title }}</h5>
                <h6 class="card-subtitle mb-3 text-muted">{{ doc.authors }}</h6>
                
                <ul class="list-unstyled small">
                    {% if doc.year %}
                    <li class="mb-2"><strong>Рік:</strong> {{ doc.year }}</li>
                    {% endif %}
                    {% if doc.source %}
                    <li class="mb-2"><strong>Джерело:</strong> {{ doc.source }}</li>
                    {% endif %}
                    <li class="mb-2"><strong>Тип:</strong> <span class="badge bg-info text-dark">{{ doc.doc_type }}</span></li>
                    <li class="mb-2"><strong>Додано:</strong> {{ doc.uploaded_at.strftime('%d.%m.%Y') }}</li>
                </ul>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#previewModal">
                        <i class="bi bi-eye"></i> Переглянути файл
                    </button>

                    <a href="{{ url_for('download_document', doc_id=doc.id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> Завантажити файл
                    </a>
                    
                    {% if current_user.id == doc.uploaded_by or current_user.role == 'admin' %}
                        <a href="{{ url_for('edit_document', doc_id=doc.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-pencil"></i> Редагувати метадані
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="confirmDelete('{{ url_for('delete_document', doc_id=doc.id) }}')">
                            <i class="bi bi-trash"></i> Видалити документ
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <span><i class="bi bi-eye"></i> Перегляд документу</span>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#previewModal">
                    <i class="bi bi-arrows-fullscreen"></i> На весь екран
                </button>
            </div>
            <div class="card-body p-0 bg-light">
                {% if doc.stored_filename.lower().endswith('.pdf') %}
                    <div class="ratio ratio-4x3" style="min-height: 500px;">
                        <iframe src="{{ url_for('view_document_file', doc_id=doc.id) }}" allowfullscreen></iframe>
                    </div>
                {% elif doc.stored_filename.lower().endswith('.docx') %}
                    <div id="docx-inline-container" class="bg-white" style="min-height: 500px; max-height: 600px; overflow-y: auto;">
                        <div class="d-flex justify-content-center align-items-center h-100 text-muted p-5">
                            <div class="spinner-border me-2" role="status"></div> Завантаження попереднього перегляду...
                        </div>
                    </div>
                {% else %}
                    <div class="p-5 text-center text-muted">
                        <i class="bi bi-file-earmark-x fs-1"></i>
                        <p class="mt-2">Перегляд для цього типу файлу недоступний.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-plus-circle"></i> Додати новий конспект
            </div>
            <div class="card-body">
                <form action="{{ url_for('add_knowledge', doc_id=doc.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Цитата або фрагмент тексту *</label>
                        <textarea name="text" class="form-control auto-resize" placeholder="Вставте сюди текст із документу..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Ваша анотація / коментар</label>
                        <textarea name="note" class="form-control auto-resize" placeholder="Ваші думки щодо цього фрагменту..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Теги</label>
                        <input type="text" name="tags" class="form-control" placeholder="напр. вступ, методологія, важливо">
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-save"></i> Зберегти конспект
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <h4 class="mb-3">Збережені фрагменти <span class="badge bg-secondary rounded-pill fs-6">{{ knowledges|length }}</span></h4>
        
        {% if knowledges %}
            <div class="vstack gap-3">
                {% for k in knowledges %}
                <div class="card shadow-sm border-start border-primary border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-end mb-2">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editModal{{ k.id }}">
                                            <i class="bi bi-pencil me-2"></i> Редагувати
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <button type="button" class="dropdown-item text-danger" onclick="confirmDelete('{{ url_for('delete_knowledge', k_id=k.id, next=request.url) }}')">
                                            <i class="bi bi-trash me-2"></i> Видалити
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <blockquote class="blockquote fs-6">{{ k.text }}</blockquote>
                        {% if k.note %}
                            <div class="alert alert-light border mb-0 p-2 small">
                                <i class="bi bi-chat-left-text me-2"></i> <strong>Примітка:</strong> {{ k.note }}
                            </div>
                        {% endif %}
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                {% if k.tags %}
                                    {% for t in k.tags.split(',') %}
                                        <span class="badge bg-light text-dark border">{{ t.strip() }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ k.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="editModal{{ k.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="{{ url_for('edit_knowledge', k_id=k.id, next=request.url) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="modal-header">
                                    <h5 class="modal-title">Редагувати запис</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Текст</label>
                                        <textarea name="text" class="form-control auto-resize" required>{{ k.text }}</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Примітка</label>
                                        <textarea name="note" class="form-control auto-resize">{{ k.note }}</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Теги</label>
                                        <input type="text" name="tags" class="form-control" value="{{ k.tags }}">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                                    <button type="submit" class="btn btn-primary">Зберегти</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info text-center">
                Ще немає збережених конспектів для цього документу.
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen"> 
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-text"></i> {{ doc.original_filename }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 bg-light text-center">
        {% if doc.stored_filename.lower().endswith('.pdf') %}
            <iframe src="{{ url_for('view_document_file', doc_id=doc.id) }}" style="width: 100%; height: 100%; border: none;"></iframe>
        {% elif doc.stored_filename.lower().endswith('.docx') %}
            <div id="docx-modal-container" class="bg-white h-100 w-100" style="overflow-y: auto;">
                <div class="d-flex justify-content-center align-items-center h-100 text-muted">
                    <div class="spinner-border me-2" role="status"></div> Завантаження...
                </div>
            </div>
        {% else %}
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-muted">
                    <i class="bi bi-eye-slash display-1"></i>
                    <p class="mt-3 fs-4">Попередній перегляд недоступний</p>
                </div>
            </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Видалення</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Ви дійсно бажаєте видалити цей елемент?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                <form id="deleteConfirmForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Видалити</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    textarea.auto-resize { resize: none; overflow-y: hidden; min-height: 80px; transition: height 0.1s ease-out; }
    /* Стилі для docx-preview, щоб виглядало як сторінка */
    .docx-wrapper { background: #f8f9fa !important; padding: 20px !important; }
    .docx-wrapper > section.docx { box-shadow: 0 0 10px rgba(0,0,0,0.1) !important; margin-bottom: 20px !important; }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- ЛОГІКА РЕНДЕРУ DOCX ---
        var docUrl = "{{ url_for('view_document_file', doc_id=doc.id) }}";
        var isDocx = {{ 'true' if doc.stored_filename.lower().endswith('.docx') else 'false' }};

        if (isDocx) {
            // 1. Рендеримо в INLINE контейнер одразу при завантаженні сторінки
            fetch(docUrl).then(res => res.blob()).then(blob => {
                var inlineContainer = document.getElementById("docx-inline-container");
                if (inlineContainer) {
                    // Очищаємо спінер
                    inlineContainer.innerHTML = "";
                    // renderAsync(blob, element, null, options)
                    docx.renderAsync(blob, inlineContainer, null, { 
                        inWrapper: true, 
                        ignoreWidth: false,
                        className: "docx"
                    }).then(x => console.log("Inline DOCX rendered"));
                }
            }).catch(err => {
                console.error(err);
                var c = document.getElementById("docx-inline-container");
                if(c) c.innerHTML = "<div class='p-4 text-danger'>Помилка завантаження документу</div>";
            });

            // 2. Рендеримо в MODAL контейнер, коли відкривається модалка
            var modal = document.getElementById('previewModal');
            var modalContainer = document.getElementById("docx-modal-container");
            var modalRendered = false; // Прапорець, щоб не рендерити двічі

            modal.addEventListener('shown.bs.modal', function () {
                if (!modalRendered && modalContainer) {
                    fetch(docUrl).then(res => res.blob()).then(blob => {
                        modalContainer.innerHTML = "";
                        docx.renderAsync(blob, modalContainer, null, { 
                            inWrapper: true,
                            ignoreWidth: false 
                        }).then(() => {
                            modalRendered = true;
                        });
                    });
                }
            });
        }

        // --- ІНШІ СКРИПТИ (TEXTAREA, DELETE) ---
        const textareas = document.querySelectorAll("textarea.auto-resize");
        function resize(el) {
            el.style.height = "auto"; 
            el.style.height = (el.scrollHeight) + "px"; 
        }
        textareas.forEach(tx => {
            tx.addEventListener("input", () => resize(tx));
            resize(tx);
        });
        var modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('shown.bs.modal', function () {
                modal.querySelectorAll('textarea.auto-resize').forEach(tx => resize(tx));
            });
        });
        window.confirmDelete = function(url) {
            const form = document.getElementById('deleteConfirmForm');
            form.action = url;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        };
    });
</script>

{% endblock %}